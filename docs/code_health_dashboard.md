# Code Health & Architecture Dashboard

- Last updated: `2026-02-27T11:20:56Z`
- Generated by: `Codex`
- Scope: `frontend/src`, `backend/src`, `backend/test`

## How To Interpret This Dashboard
- Scores are `0-100` where higher is healthier.
- Metrics are a mixed baseline of static counts and conservative estimates.
- Regression policy for Codex changes:
  - `overall_score` drop > 3 => revert.
  - `solid_compliance` drop > 2 => revert.
  - `smells` or `complexity` growth > 10% => revert.
  - coverage decrease with new non-trivial logic and no tests => revert.

## How Codex Uses This Before Each Change
1. Read `docs/code_health_dashboard.md` and `docs/code_health_metrics.json`.
2. Check weak/risky modules and plan changes to avoid new coupling.
3. Implement minimal isolated changes.
4. Re-run tests/build and update metrics.
5. Compare against thresholds; keep or revert accordingly.

## Architecture Overview

### Frontend
- `app/` routing/bootstrap
- `pages/` view-level orchestration
- `components/` reusable UI blocks (`lila/`, `journey/`, `dice3d/`)
- `features/` feature modules (`deep-mode/`, `telegram/`)
- `context/` session state orchestration (`GameContext`)
- `domain/` game rules (`gameEngine`)
- `repositories/` persistence abstractions + Dexie adapters
- `lib/` utilities (animations, board profiles, move visualization, formatting)
- `content/` static board/card data

### Backend
- `routes/` API endpoints
- `lib/` auth token + Telegram verification + Postgres access/migrations
- `store/` domain stores with Postgres-backed persistence and in-memory fallback
- `types/` transport/domain typing

### Boundary Assessment
- Positive:
  - Domain move logic isolated in `domain/gameEngine.ts`.
  - Repository abstraction exists (`repositories/contracts` + adapters).
  - Telegram feature mostly encapsulated under `features/telegram`.
- Risks:
  - `pages` contain orchestration + persistence coupling (UI + data updates).
  - `GameContext` mixes state transitions and side-effect coordination in one unit.

## Patterns & SOLID Snapshot

| Area | Evidence | Assessment |
|---|---|---|
| Repository pattern | `frontend/src/repositories/contracts`, Dexie impl | Strong |
| Feature modularization | `features/deep-mode`, `features/telegram` | Strong |
| Single Responsibility | Large page components / context reducers | Mixed |
| Open/Closed | New board profiles/theme toggles added by extension | Good |
| Dependency inversion | UI mostly depends on context/repository interfaces | Good |
| Interface segregation | Separate repo contracts for sessions/moves/insights | Good |

## Strengths
- Clear frontend/backend split with typed API boundaries.
- Domain rules (`computeNextPosition`) are separated from rendering.
- Good test footprint for critical UI components and engine behavior.
- Reusable board profile/path infrastructure supports extension.

## Weaknesses / Risk Zones
- `frontend/src/pages/GamePage.tsx` still orchestrates multiple flows, but composition pressure is reduced after extraction.
- Some duplicated UI flow logic (modal/backdrop and animation controls).
- Coverage is broad but still moderate for stateful orchestration paths.
- Multiplayer host room now has a richer contract, but `roomsStore` and `TelegramRoomsContext` still carry too many responsibilities and should eventually be split into repository/service + orchestration/store layers.

## Latest Change Impact
- Production auth + admin-scope hardening:
  - app auth token now carries Telegram chat scope (`chatInstance`, `chatType`, `startParam`), allowing backend authorization to distinguish ‚Äúuser is admin‚Äù from ‚Äúuser may host in this specific chat‚Äù;
  - added persistent `admin_chat_bindings` storage and room-host gating now checks current Telegram chat scope instead of relying on a global admin flag;
  - admin upgrade now grants admin access for the current Telegram chat scope, while super-admins still bypass scope restrictions.
- TMA auth resilience:
  - frontend Telegram bootstrap now persists the last valid app token and falls back to `/api/auth/me` when a fresh WebApp auth handshake temporarily fails, preventing unnecessary hard-locks for returning users;
  - frontend auth now tries both backend routes (`/api/auth/telegram/webapp` then `/api/auth/telegram`) and surfaces concrete backend error payloads instead of collapsing everything into generic ‚ÄúTelegram auth failed‚Äù;
  - when backend is temporarily unavailable (`500/502/503`), TMA bootstrap now enters a Telegram-runtime fallback using `initDataUnsafe.user` instead of hard-failing the whole app shell.
- Backend availability hardening:
  - server startup no longer crashes hard when `ensureDbReady()` fails at boot; API now starts in degraded mode and logs a structured startup error, preventing Caddy/Nginx upstream `502` due to process exit loops.
  - user/admin stores now fall back to in-memory operations when Postgres queries fail at runtime, so Telegram auth can still proceed instead of hard failing.
  - `/health` now exposes diagnostic readiness payload (`db` + `telegram configured`) and returns `503` when critical dependencies are down.
- Telegram UX desync visibility:
  - Telegram shell now shows explicit degraded-mode banner when auth succeeds only through runtime fallback (no backend token);
  - Home/Host Room panels now surface sync unavailability and disable server-authoritative actions while backend is down.
- Online host-room stabilization pass:
  - Host-room links opened outside Telegram now render a clean ‚ÄúOpen in Telegram‚Äù guidance screen instead of forcing broken TMA auth flow in regular browsers.
  - Telegram runtime detection now relies on real WebApp runtime presence (not just URL params), reducing false-positive auth boots in plain browser sessions.
  - Host-room participants are normalized by user id (host role priority), and room-join logic now explicitly blocks host self-duplication as a player.
  - Host-room actions now surface backend error messages directly in UI, improving diagnosis when finish/pause/start actions fail.
  - Home screen now makes Single vs Host mode a primary first decision, improving entry flow clarity for multiplayer sessions.
- Test reliability:
  - backend auth/rooms integration tests now instantiate a fresh Express app per test case to remove cross-test shared-state parse failures.
- Database migration alignment:
  - added migration `003_room_state_and_admin_chat_bindings.sql` to bring Postgres schema in line with current runtime expectations (`active_card_json`, `notes_json`, `settings_json`, `admin_chat_bindings`);
  - this closes the schema-drift class of production failures where code expected richer room state than the deployed DB schema actually had.
- Host/admin room flow expansion:
  - host-room now supports an explicit desktop-oriented host console with shared board, player roster, invite link handling, host controls, and role-aware card behavior;
  - room state model now carries `activeCard`, host/player notes, room settings, and per-move dice arrays, enabling host mirror-view of player cards without allowing other players to close —á—É–∂—ñ cards;
  - player-facing room flow remains lighter: they can roll only on their turn, close only their own active card, and update a shared token color while the rest of appearance controls stay local.
- Realtime room contract hardening:
  - Socket.IO `/host-room` events now include typed card/note/settings/player-preference actions (`closeCard`, `updateNote`, `updatePlayerPreferences`, `hostCommand:updateSettings`);
  - realtime join now prefers Telegram `@username` for participant labels and falls back to emoji-derived labels when no username exists, avoiding anonymous numeric placeholders in rooms;
  - pause/resume semantics remain server-authoritative, so host exit/app close does not destroy the room state and players can rejoin the same room URL later.
- Regression coverage added:
  - backend tests now cover host-only room setting updates and the rule that only the host may close another player‚Äôs active card.
- Telegram auth production hotfix:
  - fixed container packaging regression by copying `backend/migrations/` into backend runtime images, so Postgres-backed auth/session boot no longer fails on VPS due to missing migration files;
  - auth route now distinguishes Telegram signature failures (`401`) from backend persistence/config failures (`500`) instead of masking all auth boot errors as invalid Telegram auth.
- README refresh:
  - rewrote the root `README.md` into a shorter, more product-facing landing page with clearer local setup, architecture summary, and current feature framing;
  - removed overly dry sections and replaced them with lighter, intentionally informal copy while preserving accurate technical entry points and documentation links.
- Postgres persistence foundation:
  - added backend DB layer (`pg`) with startup migration runner and SQL migrations for users, sessions, roles, host rooms, room players and room game state;
  - converted `usersStore`, `gamesStore`, and `roomsStore` from process-memory-only maps into async repositories backed by Postgres when `DATABASE_URL` is present, while preserving in-memory fallback for tests/local DX;
  - moved auth middleware, REST routes, and host-room Socket.IO handlers onto async persistence boundaries so server state is now durable and consistent across restarts/reconnects;
  - schema intentionally keeps structured session payloads and room state in JSONB where appropriate, leaving a clean extension path for future RAG/indexing pipelines without coupling retrieval concerns to runtime game logic.
- Host/admin room control pass:
  - auth user model now includes `role`, `isAdmin`, `isSuperAdmin`, and admin-upgrade flow for host gating;
  - host room lifecycle expanded with pause/resume endpoints and persisted room status updates;
  - finishing a host room now writes per-player finished journeys into game history so multiplayer outcomes survive beyond room lifetime.
- Host room online mode (MVP):
  - upgraded room domain from draft/code stub to host-player model with shared room state, turn queue, per-player position, and room lifecycle (`open/in_progress/paused/finished`);
  - added REST lifecycle endpoints (`create`, `join`, `start`, `finish`, `get by id/code`) plus server-side turn-validated dice moves;
  - introduced Socket.IO namespace `/host-room` with authenticated realtime events (`joinRoom`, `rollDice`, `hostCommand`, `roomStateUpdated`, `tokenMoved`, `diceRolled`);
  - added client host-room store/context and dedicated `/host-room/:roomId` page with shared board, player list, turn CTA, and host controls.
- Typography system refresh (Gotham):
  - replaced remote Inter import with local Gotham font-family (Light/Book/Black) and added bundled `ttf + woff + woff2` assets under `frontend/public/fonts`;
  - introduced normalized typography tokens (`--font-primary`, `--font-heading`, `--font-accent`) and mapped existing `--lila-font-*` pipeline to them for app-wide compatibility;
  - adjusted base typographic rhythm (body size/line-height and heading letter-spacing) in one centralized stylesheet so board, modals, markdown, TMA shell and controls inherit consistently.
- Board viewport enlargement:
  - increased board-first layout width and reduced surrounding paddings to allocate more visible area to the board on mobile and desktop;
  - removed restrictive canvas max-width and trimmed nested board/container spacing so the field occupies more of its block by default;
  - preserved existing camera/zoom/hit-test behavior by changing only presentation/layout constraints.
  - follow-up pass removed board header row from inside the board block and set board panel padding to zero so the field fills the useful container area.
- Persistent game-state sync (server-authoritative):
  - added backend `GET /api/games/active` to resolve the latest in-progress session per authenticated user;
  - Telegram session sync now performs startup hydration from server before outbound sync, enforcing `server wins` during reconciliation;
  - local Dexie state remains in use as offline/local cache, but no longer overrides active server session on bootstrap;
  - added tests for active-session endpoint semantics (including finished-session exclusion) and sync-resolution logic.
- TMA haptics v2:
  - replaced single-tap vibration calls with centralized semantic API (`playDiceRoll`, `playLadderMove`, `playSnakeMove`, `playCardOpen`);
  - added sequenced pulse patterns for dice roll/ladder/snake events to improve emotional feedback without affecting gameplay timing;
  - enforced mobile-only trigger gate (`pointer: coarse`) and Telegram-Haptic-only execution (silent no-op on desktop/non-TMA);
  - updated regression tests for pattern sequencing, cooldown behavior, and desktop no-trigger constraint.
- Telegram Mini App polish pass:
  - integrated gentle `HapticFeedback` events for dice throw, land, special transition and card-open points in game flow;
  - improved TMA shell behavior with route-aware `BackButton` and `themeChanged` listener sync;
  - added safe-area/overscroll shell hardening for iOS/Android (`100dvh`, `safe-area-inset` paddings, white-flash mitigation);
  - hardened haptics with cooldown + fallback vibration path and regression tests.
- Telegram Login + history foundations:
  - backend auth now exposes `POST /api/auth/telegram` (alias for `/telegram/webapp`) and `GET /api/me`/`GET /api/auth/me` with signed app-token middleware;
  - introduced user-bound server-side game sessions API (`/api/games`) with per-user listing and resume-ready payload storage;
  - frontend Telegram shell now syncs active sessions to backend and Home page renders `–ú–æ—ó –ø–æ–¥–æ—Ä–æ–∂—ñ` list with resume/restart actions for Telegram-authenticated users;
  - added backend integration tests for `/me` and per-user session isolation, plus frontend `HomePage` history/resume test.
- Card image blending/render pipeline:
  - modal card image pane is now fully theme-driven via `theme.modal` tokens (pane/canvas backgrounds, border, inner shadow, overlay gradient), removing hardcoded image-canvas hacks;
  - added decode-first image loading flow (`Image.decode()` + onLoad fallback) and tuned unveil fade to `160ms` for stable no-flash transitions;
  - normalized modal and final-screen card previews to `object-contain` + tokenized canvas treatment for both light and dark theme compatibility.
- Theme architecture extension:
  - introduced semantic UI tokens in board theme css vars (`secondary button`, `danger`, `warning`, `success`) for reusable contrast-safe styling;
  - migrated `JourneySetupHub` simple/deep/rules panels to semantic tokens (inputs, secondary action, error banner, primary CTA, warnings), reducing hardcoded palette leakage and easing future style packs.
- Journey setup contrast fix:
  - retokenized tab switcher (`–ü—Ä–æ—Å—Ç–∞ –≥—Ä–∞ / –ì–ª–∏–±–æ–∫–∞ –≥—Ä–∞ / –ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏`) to active/inactive theme vars, removing hardcoded light palette values;
  - retokenized locked `–ì–ª–∏–±–æ–∫–∞ –≥—Ä–∞ (Coming soon)` card and overlay container for readable text/background pairing across all themes.
- Theme source-of-truth fix:
  - removed global `DeepModeThemeProvider` wrapper from app bootstrap (`main.tsx`) because it overrode `--lila-*` variables for all routes;
  - board theme tokens now remain the only active source for global UI colors, restoring full-theme consistency and predictable contrast.
- Theme visibility/accessibility hardening:
  - added board-image theme filter to make visual differences obvious directly on the board surface (not only page background);
  - introduced global compatibility layer for legacy `stone/white` utility classes so text/background/border colors follow active theme tokens and keep contrast;
  - migrated key setup/customization blocks to theme tokens (`--lila-*`) to avoid hardcoded light palette values.
- Theme reliability hotfix:
  - fixed provider race where delayed settings hydration could overwrite a user-selected theme and make switching appear broken;
  - added regression test ensuring manual theme selection persists when async settings arrive after user interaction.
- Board zoom quality refactor:
  - camera engine now accepts configurable `maxZoom` and clamps against board zoom settings instead of fixed constants;
  - board `<picture>` now serves WebP srcset directly in zoom scene while keeping PNG fallback, with new `3072` large tier assets for sharper double-tap focus.
- Cell hit-test mapping cleanup:
  - full-board profile now uses canonical serpentine coordinate source only (removed row-order compensation path);
  - pointer-to-cell resolution now derives row/column boundaries from actual cell centers, reducing drift and swap risk around first-row cells (including 2/3).
- Global theme application fix:
  - `BoardThemeProvider` now writes root CSS variables on theme change, so all major screens update instantly without reload;
  - added explicit per-theme app-level palettes to make `default-spiritual`, `cosmic-dark`, and `minimal-cream` visually distinct across the whole UI.
- Added regression coverage:
  - hit-testing tests for first-row cell boundaries and exact-center mapping;
  - theme tests for distinct CSS token resolution across themes.
- Board interaction fixes:
  - long-press zoom removed and replaced with double-tap/double-click zoom toggle;
  - single tap card-open preserved via delayed single-tap dispatch (double-tap cancels the open);
  - native context-menu/selection behavior suppressed on board surface for mobile WebView stability.
- Grid accuracy pass:
  - hit-test now resolves by board cell area in serpentine grid space with nearest-point fallback only when needed;
  - full-board calibration constants adjusted to align logical cells with rendered grid and initial token placement.
- Added regression tests for exact cell-1 start-token placement and offset hit resolution for known problem cells (23, 59).
- Game page content order adjusted for focus: control panel now renders directly under the board; future-feature cards were removed from `/game` to reduce clutter.
- Restored control panel flow placement: action block (`–ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫/–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ–¥–æ—Ä–æ–∂`) is no longer fixed/sticky and now renders inline inside page content as before.
- Camera UX corrections applied:
  - zoom now triggers only during actual token travel (normal and special transitions), not during idle/rolling states;
  - removed center-jump on exit from follow mode to avoid center->token snapping artifacts;
  - added hold-to-zoom interaction on board area while preserving tap-to-open-card behavior;
  - improved board image clarity during zoom by oversampling render strategy on the map bitmap.
- Added `BoardCameraEngine` with zoom/pan clamps, follow mode, and animated transitions (`animateTo`, `animateZoom`, `follow`).
- Added camera-aware scene wrapper `ui/board/BoardSceneContainer` so board rendering now runs through transform space instead of raw coordinates.
- Implemented dynamic movement zoom-follow (`1.0 -> 1.8 -> 1.0`) with token tracking across normal moves and special snake/ladder transitions.
- Introduced board-first mobile layout `ui/layout/GameBoardLayout` with floating bottom controls and reduced chrome density.
- Added hybrid interaction mode: camera follow + manual pan while zoomed, with clamped bounds and pointer-hit mapping in transformed space.
- Extended `BoardTheme` with layout fields (floating controls, panel spacing, zoom gradient, modal viewport margin) and connected those fields to runtime UI.
- Added `BoardCameraEngine` regression tests for zoom-follow and pan clamp guarantees.
- Ladder path geometry switched to orthogonal 90-degree stair segments with sharper step corners to remove smooth-path dotted appearance.
- Movement pacing overhaul:
  - introduced `engine/movement/MovementEngine` + centralized `MovementSettings`;
  - normal dice travel now executes explicit step-by-step timelines with pause between steps (no instant teleport feel);
  - snake/arrow transitions start only after normal path completion plus calm delay;
  - card opening delay is now tied to movement settings so modal appears after movement fully completes.
- Movement timing correction:
  - step timeline now schedules each step at step-start (not step-end), removing delayed first-step and premature last-step completion;
  - default pacing accelerated by ~20% while preserving contemplative pauses.
- Board asset pipeline overhaul:
  - runtime board rendering no longer references legacy `/field/*` print files;
  - introduced responsive board asset sets (`small/medium/large`, WebP + PNG fallback) per board profile;
  - added asset selection helper by viewport + DPR + zoom and placeholder-based fade-in loading;
  - moved print masters to `design/print/` and removed oversized originals from runtime paths.
- Unified special-transition pacing: both `snake` and `arrow` now follow `normal path -> calm delay -> transition animation -> delayed card open`.
- Snake transition now carries the token in the snake head, removing token/head layering during path travel.
- Ladder/arrow transition removed dashed residual rail effect; steps now build progressively without dotted artifacting.
- Path transition engine moved from interval ticks to `requestAnimationFrame` with explicit phases (`draw -> travel -> hold -> fade`) to improve smoothness and reduce perceived jitter.
- Removed emoji-like snake/stairs glyph overlays and replaced them with theme-driven vector heads/step motifs.
- Added reusable collapsible `AppearanceCustomizationPanel` and surfaced customization on `/` (home), `/setup`, and `/settings`.
- Added persisted snake/stairs style and color customization (`snakeStyleId`, `snakeColorId`, `stairsStyleId`, `stairsColorId`).
- Increased default animation timings and hold/fade windows for calmer transitions; reduced perceived jitter in movement and special-path reveals.
- BoardTheme foundation delivered in 4 incremental commits: visual constants moved into typed theme model and injected via provider.
- Added persisted player preferences (`selectedThemeId`, `tokenColorId`, `animationSpeed`) through existing `settingsRepository` without coupling game-engine rules to UI styling.
- Snake/ladder renderer cleanup: extracted dedicated `SnakePath` and `StairsPath` components, added theme-driven glyph filters and per-theme asset mapping.
- Added centralized zoom settings (`BoardZoomSettings`) and increased focused zoom for touch devices while preserving existing board hit-test/token mapping.
- Added centralized modal settings (`ModalAnimationSettings` + `CardLoadingSettings`) and slowed modal opening/closing timing for softer UX.
- Added mobile card-loading veil in `CellCoachModal`: veil stays until image `onLoad`, waits configured extra delay (`50ms`), then fades out.
- Added regression tests for zoom settings and veil lifecycle to reduce UX regression risk in modal/board interaction changes.
- UX customization pass: setup/settings now expose theme switch, token color palette and speed selector with persisted restore.
- Snake/Stairs variant B tuning: strengthened runtime differentiation with minimalist silver-cyan rails/body and enlarged geometric glyph overlays for clearly distinct in-game transitions.
- Snake/Stairs variant B (minimal modern): replaced legacy SVG assets with clean geometric premium set and integrated asset glyph overlays into snake/ladder path renderers for readable zoom-safe transitions.
- Snake/Stairs flow bugfix: prevented token jump-to-final before snake descent by freezing passive token sync while a move is in-flight; snake descent now starts from head consistently.
- Transition renderer stability: switched gradient IDs to per-instance unique IDs and hardened ladder step keys to prevent SVG definition/key collisions between overlapping transition renders.
- Typography variant B: added centralized typography tokens and global selectors with a modern clean sans stack (Inter + Cyrillic-safe system fallbacks) for consistent product-style readability.
- Modal animation variant B: updated card modal transitions to a mobile-first bottom-sheet slide-up pattern with matching close slide-down and stable gameplay orchestration.
- Telegram local-dev auth resilience: added localhost/LAN bypass + local fallback state so missing/invalid `initData` no longer blocks local feature testing.
- Text persistence bugfix: note saves now use per-cell upsert semantics in repositories, preventing stale/corrupted older entries from shadowing newer edits.
- UI readability bugfix: modal textarea now has larger readable typography and explicit vertical scrolling for long multilingual notes.
- Test hardening: added multilingual (UA/RU/EN + emoji + multiline) round-trip assertions for modal input and repository storage.
- Dice mode refactor: replaced animation-speed game setting with persisted `diceMode` (`classic`/`fast`/`triple`) and centralized roll logic returning both per-die values and total.
- Dice UX update: `Dice3D` now supports batch throws (1/2/3 dice) with grouped fall animation and explicit sum display, while token/modal movement tempo remains unchanged.
- Endgame logic update:
  - `triple` mode now finishes on any cell in the final row containing 68;
  - `fast` mode now auto-switches to one die in the final two rows, while preserving exact-cell finish.
- Turn dice resolution now computes an effective per-turn dice mode (UI and engine stay in sync near endgame).
- Setup dice selector redesigned into a card-based ‚Äú–§–æ—Ä–º–∞—Ç –∫–∏–¥–∫–∞‚Äù control with clearer names (`–ö–ª–∞—Å–∏—á–Ω–∞`, `–®–≤–∏–¥–∫–∞`, `–ü–∏—Ç–∞–Ω–Ω—è –¥–Ω—è`) and 1/2/3 dice mini-icons.
- UX adjustment: dice mode selector moved from setup flow to `–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂—ñ` so game-start screen stays cleaner.
- Temporary visual simplification: replaced custom mini dice glyphs with emoji (`üé≤`, `üé≤üé≤`, `üé≤üé≤üé≤`) until dedicated assets are prepared.
- UX consolidation: dice mode selection is now integrated directly into `AppearanceCustomizationPanel` (existing customization block), and standalone duplicate controls were removed.
- Regression hotfix: restored card/field asset availability in Vite dev by proxying `/cards` and `/field` to backend static endpoints.
- Zoom quality hotfix: board asset tier selection now upgrades earlier during zoom transitions (uses target zoom), reducing blur/pixel stretch on mobile focus zoom.
- Dice cluster polish: multi-dice throws now land in a scattered cluster (x/z offsets + subtle per-die jitter) instead of a strict horizontal row.
- Dev runtime fix: Vite now serves `/cards/*` and `/field/*` directly from workspace folders, so card media loads even when backend is not running.
- Card modal polish: removed blur effect from loading veil to prevent whole-modal "milky" appearance while card image initializes on mobile.
- Board texture quality: disabled WebP-first board source in zoom scene, preferring PNG srcset for sharper text/detail under camera scale.
- Documentation refresh: modernized `README.md` as a complete project landing page with architecture, setup, deployment, and contribution guidance.
- Board/card interaction upgrade: added click-to-open card selection from board coordinates with zoom/pan-safe pointer mapping.
- Snake UX sequence: implemented head card -> snake path animation -> tail card orchestration with locked interaction window during transition.
- UX polish/tests: ESC-close path preserved, dedicated hit-detection unit tests and GamePage snake-flow integration tests added.
- Top-risk refactor pass:
  - `GameContext` split into reducer/types/action modules.
  - `HistoryPage` data access extracted into `useHistoryData`.
  - `TelegramAppShell` split into runtime/auth/UI/fullscreen hooks.
  - `GamePage` reduced via `useSimpleMultiplayer` and extracted presentational dialogs/sections.

## Metrics Table

| Metric | Value |
|---|---:|
| Total files (scanned) | 172 |
| Source files | 172 |
| Source LOC | 16969 |
| Frontend files / LOC | 155 / 14075 |
| Backend files / LOC | 17 / 2894 |
| Test files / LOC | 38 / 2889 |
| Test file ratio vs source | 22.1% |
| Source files with direct test match | 29.7% |
| Coverage estimate | 73% (medium) |
| Long files > 500 LOC | 1 |
| Long files > 300 LOC | 4 |
| Long functions > 50 LOC | 18 |
| Duplicate blocks (estimate) | 6 |
| SOLID violations (estimate) | 7 |
| Smells per 1k LOC | 2.40 |

## Scorecard

| Score | Value |
|---|---:|
| Overall health | 89 |
| Architecture clarity | 90 |
| SOLID compliance | 88 |
| Test coverage | 72 |
| Complexity | 82 |
| Consistency | 89 |

## Top Risk Modules
- `frontend/src/pages/GamePage.tsx` (medium): main gameplay orchestrator remains large, though special-flow branching reduced and movement timing is now centralized.
- `frontend/src/components/lila/LilaBoardCanvas.tsx` (medium): camera follow, token/path sync, pointer hit mapping and adaptive board asset loading remain concentrated in a single component.
- `frontend/src/features/telegram/ui/TelegramAppShell.tsx` (low): shell concerns are clearer, but route-aware Telegram buttons + auth UI + fullscreen prompt still coexist in one component.
- `frontend/src/theme/BoardThemeProvider.tsx` (low): coordinates persisted visual preferences and derived path style overrides.
- `frontend/src/context/GameContext.tsx` (low): thin provider wrapper around reducer + action modules.

## Baseline Notes
- This is the initial persisted baseline for regression checks.
- Future Codex changes must update both dashboard files in the same commit.
