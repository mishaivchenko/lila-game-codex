# Code Health & Architecture Dashboard

- Last updated: `2026-02-25T18:45:00Z`
- Generated by: `Codex`
- Scope: `frontend/src`, `backend/src`, `backend/test`

## How To Interpret This Dashboard
- Scores are `0-100` where higher is healthier.
- Metrics are a mixed baseline of static counts and conservative estimates.
- Regression policy for Codex changes:
  - `overall_score` drop > 3 => revert.
  - `solid_compliance` drop > 2 => revert.
  - `smells` or `complexity` growth > 10% => revert.
  - coverage decrease with new non-trivial logic and no tests => revert.

## How Codex Uses This Before Each Change
1. Read `docs/code_health_dashboard.md` and `docs/code_health_metrics.json`.
2. Check weak/risky modules and plan changes to avoid new coupling.
3. Implement minimal isolated changes.
4. Re-run tests/build and update metrics.
5. Compare against thresholds; keep or revert accordingly.

## Architecture Overview

### Frontend
- `app/` routing/bootstrap
- `pages/` view-level orchestration
- `components/` reusable UI blocks (`lila/`, `journey/`, `dice3d/`)
- `features/` feature modules (`deep-mode/`, `telegram/`)
- `context/` session state orchestration (`GameContext`)
- `domain/` game rules (`gameEngine`)
- `repositories/` persistence abstractions + Dexie adapters
- `lib/` utilities (animations, board profiles, move visualization, formatting)
- `content/` static board/card data

### Backend
- `routes/` API endpoints
- `lib/` auth token + Telegram verification
- `store/` in-memory/domain stores
- `types/` transport/domain typing

### Boundary Assessment
- Positive:
  - Domain move logic isolated in `domain/gameEngine.ts`.
  - Repository abstraction exists (`repositories/contracts` + adapters).
  - Telegram feature mostly encapsulated under `features/telegram`.
- Risks:
  - `pages` contain orchestration + persistence coupling (UI + data updates).
  - `GameContext` mixes state transitions and side-effect coordination in one unit.

## Patterns & SOLID Snapshot

| Area | Evidence | Assessment |
|---|---|---|
| Repository pattern | `frontend/src/repositories/contracts`, Dexie impl | Strong |
| Feature modularization | `features/deep-mode`, `features/telegram` | Strong |
| Single Responsibility | Large page components / context reducers | Mixed |
| Open/Closed | New board profiles/theme toggles added by extension | Good |
| Dependency inversion | UI mostly depends on context/repository interfaces | Good |
| Interface segregation | Separate repo contracts for sessions/moves/insights | Good |

## Strengths
- Clear frontend/backend split with typed API boundaries.
- Domain rules (`computeNextPosition`) are separated from rendering.
- Good test footprint for critical UI components and engine behavior.
- Reusable board profile/path infrastructure supports extension.

## Weaknesses / Risk Zones
- `frontend/src/pages/GamePage.tsx` still orchestrates multiple flows, but composition pressure is reduced after extraction.
- Some duplicated UI flow logic (modal/backdrop and animation controls).
- Coverage is broad but still moderate for stateful orchestration paths.

## Latest Change Impact
- Board interaction fixes:
  - long-press zoom removed and replaced with double-tap/double-click zoom toggle;
  - single tap card-open preserved via delayed single-tap dispatch (double-tap cancels the open);
  - native context-menu/selection behavior suppressed on board surface for mobile WebView stability.
- Grid accuracy pass:
  - hit-test now resolves by board cell area in serpentine grid space with nearest-point fallback only when needed;
  - full-board calibration constants adjusted to align logical cells with rendered grid and initial token placement.
- Added regression tests for exact cell-1 start-token placement and offset hit resolution for known problem cells (23, 59).
- Game page content order adjusted for focus: control panel now renders directly under the board; future-feature cards were removed from `/game` to reduce clutter.
- Restored control panel flow placement: action block (`Кинути кубик/Завершити подорож`) is no longer fixed/sticky and now renders inline inside page content as before.
- Camera UX corrections applied:
  - zoom now triggers only during actual token travel (normal and special transitions), not during idle/rolling states;
  - removed center-jump on exit from follow mode to avoid center->token snapping artifacts;
  - added hold-to-zoom interaction on board area while preserving tap-to-open-card behavior;
  - improved board image clarity during zoom by oversampling render strategy on the map bitmap.
- Added `BoardCameraEngine` with zoom/pan clamps, follow mode, and animated transitions (`animateTo`, `animateZoom`, `follow`).
- Added camera-aware scene wrapper `ui/board/BoardSceneContainer` so board rendering now runs through transform space instead of raw coordinates.
- Implemented dynamic movement zoom-follow (`1.0 -> 1.8 -> 1.0`) with token tracking across normal moves and special snake/ladder transitions.
- Introduced board-first mobile layout `ui/layout/GameBoardLayout` with floating bottom controls and reduced chrome density.
- Added hybrid interaction mode: camera follow + manual pan while zoomed, with clamped bounds and pointer-hit mapping in transformed space.
- Extended `BoardTheme` with layout fields (floating controls, panel spacing, zoom gradient, modal viewport margin) and connected those fields to runtime UI.
- Added `BoardCameraEngine` regression tests for zoom-follow and pan clamp guarantees.
- Ladder path geometry switched to orthogonal 90-degree stair segments with sharper step corners to remove smooth-path dotted appearance.
- Unified special-transition flow: both `snake` and `arrow` now follow `head-card -> close -> transition animation -> tail-card`.
- Snake transition now carries the token in the snake head, removing token/head layering during path travel.
- Ladder/arrow transition removed dashed residual rail effect; steps now build progressively without dotted artifacting.
- Path transition engine moved from interval ticks to `requestAnimationFrame` with explicit phases (`draw -> travel -> hold -> fade`) to improve smoothness and reduce perceived jitter.
- Removed emoji-like snake/stairs glyph overlays and replaced them with theme-driven vector heads/step motifs.
- Added reusable collapsible `AppearanceCustomizationPanel` and surfaced customization on `/` (home), `/setup`, and `/settings`.
- Added persisted snake/stairs style and color customization (`snakeStyleId`, `snakeColorId`, `stairsStyleId`, `stairsColorId`).
- Increased default animation timings and hold/fade windows for calmer transitions; reduced perceived jitter in movement and special-path reveals.
- BoardTheme foundation delivered in 4 incremental commits: visual constants moved into typed theme model and injected via provider.
- Added persisted player preferences (`selectedThemeId`, `tokenColorId`, `animationSpeed`) through existing `settingsRepository` without coupling game-engine rules to UI styling.
- Snake/ladder renderer cleanup: extracted dedicated `SnakePath` and `StairsPath` components, added theme-driven glyph filters and per-theme asset mapping.
- UX customization pass: setup/settings now expose theme switch, token color palette and speed selector with persisted restore.
- Snake/Stairs variant B tuning: strengthened runtime differentiation with minimalist silver-cyan rails/body and enlarged geometric glyph overlays for clearly distinct in-game transitions.
- Snake/Stairs variant B (minimal modern): replaced legacy SVG assets with clean geometric premium set and integrated asset glyph overlays into snake/ladder path renderers for readable zoom-safe transitions.
- Snake/Stairs flow bugfix: prevented token jump-to-final before snake descent by freezing passive token sync while a move is in-flight; snake descent now starts from head consistently.
- Transition renderer stability: switched gradient IDs to per-instance unique IDs and hardened ladder step keys to prevent SVG definition/key collisions between overlapping transition renders.
- Typography variant B: added centralized typography tokens and global selectors with a modern clean sans stack (Inter + Cyrillic-safe system fallbacks) for consistent product-style readability.
- Modal animation variant B: updated card modal transitions to a mobile-first bottom-sheet slide-up pattern with matching close slide-down and stable gameplay orchestration.
- Telegram local-dev auth resilience: added localhost/LAN bypass + local fallback state so missing/invalid `initData` no longer blocks local feature testing.
- Text persistence bugfix: note saves now use per-cell upsert semantics in repositories, preventing stale/corrupted older entries from shadowing newer edits.
- UI readability bugfix: modal textarea now has larger readable typography and explicit vertical scrolling for long multilingual notes.
- Test hardening: added multilingual (UA/RU/EN + emoji + multiline) round-trip assertions for modal input and repository storage.
- Documentation refresh: modernized `README.md` as a complete project landing page with architecture, setup, deployment, and contribution guidance.
- Board/card interaction upgrade: added click-to-open card selection from board coordinates with zoom/pan-safe pointer mapping.
- Snake UX sequence: implemented head card -> snake path animation -> tail card orchestration with locked interaction window during transition.
- UX polish/tests: ESC-close path preserved, dedicated hit-detection unit tests and GamePage snake-flow integration tests added.
- Top-risk refactor pass:
  - `GameContext` split into reducer/types/action modules.
  - `HistoryPage` data access extracted into `useHistoryData`.
  - `TelegramAppShell` split into runtime/auth/UI/fullscreen hooks.
  - `GamePage` reduced via `useSimpleMultiplayer` and extracted presentational dialogs/sections.

## Metrics Table

| Metric | Value |
|---|---:|
| Total files (scanned) | 164 |
| Source files | 164 |
| Source LOC | 10749 |
| Frontend files / LOC | 152 / 10288 |
| Backend files / LOC | 12 / 461 |
| Test files / LOC | 30 / 1622 |
| Test file ratio vs source | 18.3% |
| Source files with direct test match | 28.0% |
| Coverage estimate | 70% (medium) |
| Long files > 500 LOC | 1 |
| Long files > 300 LOC | 2 |
| Long functions > 50 LOC | 16 |
| Duplicate blocks (estimate) | 6 |
| SOLID violations (estimate) | 7 |
| Smells per 1k LOC | 2.98 |

## Scorecard

| Score | Value |
|---|---:|
| Overall health | 85 |
| Architecture clarity | 87 |
| SOLID compliance | 84 |
| Test coverage | 70 |
| Complexity | 80 |
| Consistency | 86 |

## Top Risk Modules
- `frontend/src/pages/GamePage.tsx` (medium): main gameplay orchestrator remains large though now composes camera/layout flows through props and hooks.
- `frontend/src/components/lila/LilaBoardCanvas.tsx` (medium): camera follow, drag pan, token/path sync and transformed pointer mapping live together.
- `frontend/src/theme/BoardThemeProvider.tsx` (low): coordinates persisted visual preferences and derived path style overrides.
- `frontend/src/context/GameContext.tsx` (low): thin provider wrapper around reducer + action modules.

## Baseline Notes
- This is the initial persisted baseline for regression checks.
- Future Codex changes must update both dashboard files in the same commit.
